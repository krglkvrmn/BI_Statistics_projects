---
title: "Проект №2"
date: "10/10/2020"
output:
  html_document:
    df_print: paged
    toc: true
    toc_float: true
    number_sections: true
editor_options: 
  chunk_output_type: console
---
<style>
p.caption {
  font-size: 0.9em;
  font-style: italic;
  color: grey;
  margin-right: 10%;
  margin-left: 10%;  
  text-align: center;
}
</style>

```{r setup, include=FALSE, cache=FALSE}

if (!require(MASS)) {install.packages("MASS")}
if (!require(regclass)) {install.packages("regclass")}
if (!require(ggplot2)) {install.packages("ggplot2")}
if (!require(psych)) {install.packages("psych")}
if (!require(car)) {install.packages("car")}
```

# Описание данных

Я буду использовать данные о ценности жилья в бостоне в 1970-1980-х годах. В данных представлены следующие переменные:

<pre>
CRIM - per capita crime rate by town
ZN - proportion of residential land zoned for lots over 25,000 sq.ft.
INDUS - proportion of non-retail business acres per town.
CHAS - Charles River dummy variable (1 if tract bounds river; 0 otherwise)
NOX - nitric oxides concentration (parts per 10 million)
RM - average number of rooms per dwelling
AGE - proportion of owner-occupied units built prior to 1940
DIS - weighted distances to five Boston employment centres
RAD - index of accessibility to radial highways
TAX - full-value property-tax rate per $10,000
PTRATIO - pupil-teacher ratio by town
B - 1000(Bk - 0.63)^2 where Bk is the proportion of blacks by town
LSTAT - % lower status of the population
MEDV - Median value of owner-occupied homes in $1000's
</pre>
Переменные chas и rad являются факторными.

```{r}
data("Boston")
Boston$chas <- factor(Boston$chas)
Boston$rad <- factor(Boston$rad)
str(Boston)
```
Поскольку переменные представлены в различных величинах, для построения модели необходимо стандартизовать предикторы. Это позволит наиболее объективно сравнивать вклад различных предикторов в объяснение изменчивости.

```{r}
Boston[, -c(4,9,14)] <- as.data.frame(apply(Boston[,-c(4,9,14)], 2, scale))
```

# Исследование полной линейной модели

## Построение модели

Построим полную линейную модель без взаимодействия предикторов.

```{r}
model <- lm(medv ~ crim + zn + indus + chas + nox + rm + age + dis + rad + tax + ptratio + black + lstat, data=Boston)
summary(model)
```

```{r include=FALSE}
model_diag <- fortify(model)
```

## Диагностика модели

### Проверка на наличие влиятельных наблюдений

```{r echo=FALSE, fig.cap="Рисунок 1. График расстояний Кука для полной модели"}
ggplot(model_diag, aes(x=1:nrow(model_diag), y = .cooksd)) +
  geom_bar(stat = "identity") + 
  geom_hline(yintercept = 2, color = "red") +
  labs(x = "№ Наблюдения", y = "Расстояник Кука")
```

Из графика видно, что влиятельных наблюдений нет.

### Проверка на гомогенность дисперсии и линейность взаимосвязи

```{r echo=FALSE, fig.cap="Рисунок 2. График распределения остатков полной модели", message=FALSE, warning=FALSE}
ggplot(model_diag, aes(x=.fitted, y = .stdresid)) +
  geom_point() +
  geom_smooth(method = "lm") +
  geom_hline(yintercept = 0) +
  geom_hline(yintercept = 2, color = "red") +
  geom_hline(yintercept = -2, color = "red") +
  labs(x = "Предсказанное значение", y = "Стандартное отклонение распределения остатков")
```

Дисперсия остатков распределена не равномерно. Наблюдаются сильные отклонения при низких и высоких значениях зависимой переменной. Некоторые наблюдения отклоняются более чем на 2 стандартных отклонения, но в целом взаимосвязь кажется линейной.

### Проверка на нормальность распределения и коллинеарность предикторов

```{r echo=FALSE, message=FALSE, fig.cap="Рисунок 3. Квантиль-квантильный график для остатков полной модели"}
a <- qqPlot(model_diag$.stdresid, distribution = "norm", xlab = "Теоретические квантили", ylab = "Эмпирические квантили")
```

Распределение отличается от нормального. Наюлюдаются сильные отклонения от нормальности при высоких значениях зависимой переменной.

## Предсказания модели

Построим предсказания модели для переменной **lstat**, коэффициент которой в полной модели равен **-3.77**.

```{r echo=FALSE, fig.cap="Рисунок 4. Зависимость переменной medv от переменной lstat c предсказанными моделью значениями"}
df <- Boston
df[,-c(4,9,13,14)] <- 0
df$rad <- 1
df$chas <- 1
df$rad <- factor(df$rad)
df$chas <- factor(df$chas)
predicted <- predict(model, newdata=df, interval = 'confidence')
df <- cbind(df, data.frame(predicted))
ggplot(df, aes(x = lstat, y = fit)) +
  geom_ribbon(alpha = 0.2, aes(ymin = lwr, ymax = upr), color = "yellow") +
  geom_point(aes(x = lstat, y = medv)) +
  geom_line(color = "red") + 
  labs(y = "medv")
```

Из графика видно, что переменная **lstat** хорошо описывает всю модель только на небольшом интервале значений.

# Поиск оптимальной модели

## Удаление коллинеарных предикторов

Рассмотрим модель на предмет наличия коллинеарных предикторов, расчитав фактор вздутия дисперсии.

```{r}
VIF(model)
```

Уберём предикторы с самым большим VIF, пока не останутся только предикторы с VIF < 2.

```{r}
model_1 <- update(model, .~. - rad)
VIF(model_1)

model_2 <- update(model_1, .~. - dis)
VIF(model_2)

model_3 <- update(model_2, .~. - nox)
VIF(model_3)

model_4 <- update(model_3, .~. - indus)
VIF(model_4)

# model_5 <- update(model_4, .~. - lstat)
# VIF(model_5)

model_6 <- update(model_4, .~. - tax)
VIF(model_6)
```
Несмотря на то, что предиктор **lstat** имеет VIF больший 2, он был оставлен в модели, так как очень хорошо объясняет изменчивость зависимой переменной.

## Удаление незначимых предикторов

На данный момент в нашей модели осталось 8 предикторов, однако не все предикторы могут одинаково хорошо объяснять изменчивость модели. Для нахождения незначимых предикторов воспользуемся подходом *backward selection*.

```{r echo=FALSE}
drop1(model_6, test = "F")
```

Видно, что предикторы **zn, crim, age** не влияют значимо на количество объяснённой моделью изменчивости, поэтому их следует удалить.

После удаления незначимого предиктора модель имеет следующий вид:
<a id="optimized_model"></a>
```{r echo=FALSE}
model_7 <- update(model_6, .~. - zn - age - crim)
summary(model_7)
```

```{r}
VIF(model_7)
```
Видно, что VIF предиктора **lstat** стал меньше 2.

## Диагностика модели

Проведём диагностику оптимизированной модели.

```{r echo=FALSE, fig.cap="Рисунок 5. График расстояний Кука для оптимизированной модели"}
model_diag1 <- fortify(model_7)
ggplot(model_diag1, aes(x=1:nrow(model_diag1), y = .cooksd)) +
  geom_bar(stat = "identity") + 
  geom_hline(yintercept = 2, color = "red") +
  labs(x = "№ Наблюдения", y = "Расстояник Кука")
```

Влиятельные наблюдения отсутствуют.

```{r echo=FALSE, message=FALSE, warning=FALSE, fig.cap="Рисунок 6. Распределение остатков для оптимизированной модели"}
ggplot(model_diag1, aes(x=.fitted, y = .stdresid)) +
  geom_point() +
  geom_smooth(method = "lm") +
  geom_hline(yintercept = 0) +
  geom_hline(yintercept = 2, color = "red") +
  geom_hline(yintercept = -2, color = "red") +
  labs(x = "Предсказанное значение", y = "Стандартное отклонение распределения остатков")
```

Паттерны в распределении остатков не исчезли, однако теперь стало меньше отклоняющихся более чем на 2 стандартных отклонения.

```{r echo=FALSE, fig.cap="Рисунок 7. Квантиль-квантильный график для остатков оптимизированной модели"}
qqPlot(model_diag1$.stdresid,  distribution = "norm", xlab = "Теоретические квантили", ylab = "Эмпирические квантили")
```
Распределение остатков не является нормальным.

## Задача максимизации цены дома

Ещё раз посмотрим на [модель](#optimized_model). Модель однозначно нельзя назвать полностью оптимизированной, однако нам удалось её немного улучшить. R^2 модели приблизительно равен **0.7**.

Для того, чтобы максимизировать цену за продаваемый дом, необходимо учесть на какие из значимых предикторов в реальности можно повлиять, чтобы увеличить значение зависимой переменной.

Рассмотрим предикторы по очереди:

### chas

Факторная переменная *chas* означает расположение дома у реки.
Её коэффициент в модели равен **3.32** и является наибольшим. Таким образом цену дома можно сильно увеличить, построив его у реки.

### rm

Количественная переменная *rm* показывает среднее количество комнат в доме.
Её коэффициент в модели равен **3.27**, а значит также существенно оказывает влияние на зависимую переменную. Увеличение количества комнат в доме будет приводить к увеличению его стоимости.

При постройке дома заказчик непосредственно может повлиять только на эти переменные.
Однако мы также можем дать некоторые рекомендации по выбору оптимального районе.

### ptratio

Количественная переменная *ptratio* показывает отношении количества учеников к количеству учителей.
Её коэффициент в модели равен **-1.86**. Это значит, что более предпочтительным будет район, где на одного учителя будет приходится меньше учеников, что, возможно, повышает качество образования.

### black

Количественная переменная *black* показывает преобразованные данные о проценте чернокожего населения (black = 1000(Bk - 0.63)^2, где Bk - доля чернокожего населения). Эта переменная будет оказывать одинаковое влияние на зависимую переменную при увеличении или уменьшении процента чернокожего населения, однако при уменьшении могут быть достигнуты бОльшие значения переменной *black*. Например, $1000(1 - 0.63)^2 < 1000(0 - 0.63)^2$. Таким образом можно было бы порекомендовать заказчику выбрать район с максимальным процентом белого населения, но мы не расисты и не будем так делать! Тем более, что значение коэффициента предиктора равно всего лишь **0.92** и не будет оказывать столь значительное влияние на цену.

### lstat

Количественная переменная *lstat* является довольно сложной социально-экономической характеристикой, учитывающей количество взрослых без высшего образования и чернорабочих. Поскольку коэффициент в модели равен **-3.7**, данный предиктор будет оказывать наиболее сильное влияние на значение зависимой переменной. Выбор района с высокими показателями образованности и занятости населения  позволит существенно повысить цену дома.


## Итоговая рекомендация

Наиболее выгодной будет постройка дома с более, чем 8 комнатами возле реки в районе с большим количеством учителей, высокой образованностью населения и высокой квалификацией рабочих.























